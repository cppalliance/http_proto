//
// Copyright (c) 2023 Vinnie Falco (vinnie.falco@gmail.com)
//
// Distributed under the Boost Software License, Version 1.0. (See accompanying
// file LICENSE_1_0.txt or copy at https://www.boost.org/LICENSE_1_0.txt)
//
// Official repository: https://github.com/cppalliance/http_proto
//

= Messages

The library provides both modifiable containers and immutable views for
requests, responses, and standalone field sets such as trailers. These can
be used to store incoming messages or construct outgoing ones. Unlike other
libraries, such as its predecessor Boost.Beast, the message body is kept
separate. In other words, the containers and views offered by this library
do not include the body.

NOTE: By omitting the body from its container and view types, the library avoids
the need for templates—unlike the message container in Boost.Beast. Experience
has shown that templated containers create poor ergonomics, a design flaw this
library corrects.

The following table lists the types used to model containers and views:

[cols="1a,4a"]
|===
|Type|Description

|cpp:fields[]
|A modifiable container of header fields.

|cpp:fields_view[]
|A read-only view to a cpp:fields[]

|cpp:message[]
|A modifiable container holding a start-line and header fields, with
 accompanying metadata.

|cpp:message_view[]
|A read-only view to a cpp:message[]

|cpp:request[]
|A modifiable container holding a request-line and header fields, with
 accompanying metadata.

|cpp:request_view[]
|A read-only view to a cpp:request[]

|cpp:response[]
|A modifiable container holding a status-line and header fields, with
 accompanying metadata.

|cpp:response_view[]
|A read-only view to a cpp:response[]

|===

== Construction

All containers maintain the following invariants:

* The container’s contents are always stored in serialized form that is
  syntactically valid.

* Any modification that would produce a malformed field or start line
  throws an exception, with strong exception safety guaranteed.

To satisfy these invariants, default-constructed containers
initially consist of a start line:

[source,cpp]
----
request req;
response res;

assert(req->buffer() == "GET / HTTP/1.1\r\n\r\n");
assert(res->buffer() == "HTTP/1.1 200 OK\r\n\r\n");
----

The `buffer` function runs in constant time, never throws exceptions,
and returns a cpp:boost::core::string_view[] representing the complete
serialized object.

Each header field consists of a name and a value, both stored as strings,
with prescribed ABNF format:

[source]
----
field-name     = token
field-value    = *( field-content / obs-fold )
field-content  = field-vchar [ 1*( SP / HTAB ) field-vchar ]
field-vchar    = VCHAR / obs-text

obs-fold       = CRLF 1*( SP / HTAB )
               ; obsolete line folding
----

Operations that create or modify fields throw an exception if the name or
value violates the syntactic requirements of the protocol.

Although fields may be identified by comparing their names, the library
provides the field enumeration, which defines a wide set of constants for
well-known field names. Internally, containers maintain a lookup table so
that specifying fields by enumeration replaces costly string comparisons
with efficient integer comparisons.

The following example builds an
https://tools.ietf.org/html/rfc7231#section-4.3.1[HTTP GET]
request:

[cols="1a,1a"]
|===
|Code|Serialized Result

|
[source,cpp]
----
request req( method::get, "/index.htm", version::http_1_1 );
req.append( field::accept, "text/html" );
req.append( "User-Agent", "Boost" );
----
|
[literal]
GET /index.htm HTTP/1.1\r\n
Accept: text/html\r\n
User-Agent: Boost\r\n
\r\n

|===

NOTE: Field-specific syntax (e.g., for date values) is not fully validated by
this library. It is the application’s responsibility to follow the relevant
specifications to ensure correct behavior.
